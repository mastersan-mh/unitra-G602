# Описание режимов работы

## 1.1 Стоп

  + Описание

    Стол остановлен, лифт поднят.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Включение базовой скорости 45 об/мин | Нет       |
| `[33]`           | Включение базовой скорости 33 об/мин | Нет       |
| `[АВТОСТОП]`     | Нет                                  | Нет       |
| `[ПУСК]`         | Переход в режим [1.2]                | <1>       |
| `[СТОП]`         | Нет                                  | Нет       |
| `[СТОП]` в течении 5 секунд | Переход в режим [2.1]     | <6>       |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

## 1.2 Воспроизведение с фиксированной скоростью

  + Описание

    Воспроизведение с фиксированной скоростью, выбранной переключателями [45]/[33]. Стол вращается, лифт опущен.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1.1]                   | Нет       |
| `[33]`           | Смотри режим [1.1]                   | Нет       |
| `[АВТОСТОП]`     | Включение режима автоматической остановки стола и поднятия лифта при достижении конца записи | Нет |
| `[ПУСК]`         | Переход в режим [1.3]                | <5>       |
| `[СТОП]`         | Переход в режим [1.1]                | <2>       |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

## 1.3 Воспроизведение с регулируемой скоростью

  + Описание

    Воспроизведение со скоростью, выбранной переключателями [45]/[33] с возможность ручной подстройки регулятором [РЕГУЛЯТОР]:
    для базовой скорости 45 - в диапазоне от 39 до 51, для базовой скорости 33 - в диапазоне от 27 до 39 об/мин.
    Стол вращается, лифт опущен.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1.1]                   | Нет       |
| `[33]`           | Смотри режим [1.1]                   | Нет       |
| `[АВТОСТОП]`     | Смотри режим [1.2]                   | Нет       |
| `[ПУСК]`         | Переход в режим [1.2]                | <5>       |
| `[СТОП]`         | Переход в режим [1.1]                | <2>       |
| `[РЕГУЛЯТОР]`    | Ручная подстройка скорости воспроизведения | Нет |

### 2.1. Сервисный режим #1

  + Описание

    Режим настройки иглы: Стол остановлен, лифт опущен.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1.1]                   | Нет       |
| `[33]`           | Смотри режим [1.1]                   | Нет       |
| `[АВТОСТОП]`     | Смотри режим [1.2]                   | Нет       |
| `[ПУСК]`         | Запуск режима                        | Нет       |
| `[СТОП]`         | Остановка режима / Переход в режим [2.2] | <2> / <4> |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

### 2.2. Сервисный режим #2

  + Описание

    Режим настройки скатывания иглы: Стол вращается, лифт опущен

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1.1]                   | Нет       |
| `[33]`           | Смотри режим [1.1]                   | Нет       |
| `[АВТОСТОП]`     | Смотри режим [1.2]                   | Нет       |
| `[ПУСК]`         | Запуск режима                        | Нет       |
| `[СТОП]`         | Остановка режима / Переход в режим [2.3] | <2> / <5> |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

### 3.3. Сервисный режим #3

  + Описание

    Настройки регулятора скорости внешними командами, принятыми из последовательного порта

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1.1]                   | Нет       |
| `[33]`           | Смотри режим [1.1]                   | Нет       |
| `[АВТОСТОП]`     | Смотри режим [1.2]                   | Нет       |
| `[ПУСК]`         | Запуск режима                        | Нет       |
| `[СТОП]`         | Остановка режима / Переход в режим [1.1] | <2> / <6> |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

# Индикация

| № | Тип мигания                     | Тип мигания                     | Значение                                    |
| - | ------------------------------- | ------------------------------- | ------------------------------------------- |
| 1 | `*-**--***---****----*****`     | Ускоряющееся мигание            | Запуск воспроизведения                      |
| 2 | `*****-----****----***---**--*` | Замедляющееся мигание           | Остановка воспроизведения                   |
| 3 | `**`                            | 1 мигание                       | Включено автоматическое упавление скоростью / Переход в сервисный режим #1 |
| 4 | `**--**`                        | 2 мигание                       | Переход в сервисный режим #2 |
| 5 | `**--**--**`                    | 3 мигания                       | Включено ручное упавление скоростью / Переход в сервисный режим #3 |
| 6 | `*-*-*-*-*-*`                   | Частое мигание 6 раз            | Переход в меню переключения сервисных режимов / Выход из меню сервисных режимов |
| 7 | `***---...`                     | медленное непрерывное мигание   | Торможение стола выбегом                    |
| 8 | `*-...`                         | частое непрерывное мигание      | Разгон стола                                |

# Протокол коммуникации посредством последовательного порта

## Назначение

Коммуникация посредством последовательного порта нужна для отладки изделия и для настройки коэффициентов регулятора скорости стола.

## Формат команды

Команды представляют собой набор ASCII-символов в 8-битной кодировке. Все числа представляются в 16-ричном формате,
цифры представлены множеством символов 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, A, B, C, D, E, F.

* Формат кадра нижнего уровня:

`<start><frame><CRC><stop>`

`<start>`   - символ ':'.

`<stop>`    - Любой из символов LF (0x0A, '\n'), CR (0x0D, '\r') и их сочетания, 1-2 байта. В кадре ответа всегда LF.
              Любые внекадровые символы CR/LF игнорируются.

`<CRC>`     - Контрольная сумма <frame>, 16 бит, CRC-16-IBM, полином 0xA001.

* Кадр запроса:

`<frame> = <ruid><funcid><argc><argv>`

`<ruid>`     - [16 бит] Произвольное число, испрользуется для идентификации запроса и ответа. Ответ содержит то-же число, что и запрос.

`<funcid>`   - [8 бит] Код функции.

`<argc>`     - [8 бит] Количество аргументов [0; 8]

`<argv>`     - [16 * <argc> бит] Вектор аргументов.

* Кадр ответа:

`<frame> = <type>{ <ruid><error><resc><resv> | <eventid><resc><resv> }`

`<type>`     - [8 бит] тип ответа: 0x00 - ответ на вызов процедуры; 0x01 - событие

`<error>`    - [8 бит] Код ошибки.

`<eventid>`  - [8 бит] Код события.

`<resc>`     - [8 бит] Количество чисел в ответе.

`<resv>`     - [16 * <resc> бит] Вектор ответов.

Приечание: старший байт стоит первым (Network byte order)

### Процедуры

1. Прочитать значение количества имульсов на один оборот стола.

    * Запрос:

    `<funcid> = 0x00`

    `<argc> = 0`

    * Ответ:

    `<resc> = 1`

    `<argv[0]>` - Количество импульсов на один оборот стола.

    + Доступность: Все режимы

    + Пример:

      + Запрос: ":abcd0000ffb1\n"

      + Ответ: ":00abcd00010004087f\n"

2. Прочитать номер режима.

    * Запрос:

    `<funcid> = 0x01`

    `<argc> = 0`

    * Ответ:

    `<resc> = 1`

    `<resv[0]>` - номер режима.

| Значение | Режим        |
| -------- | ------------ |
| 0x1000   | 1.1          |
| 0x1001   | 1.2          |
| 0x1002   | 1.3          |
| 0x2100   | 2.1: stopped |
| 0x2101   | 2.1: started |
| 0x2200   | 2.2: stopped |
| 0x2201   | 2.2: started |
| 0x2300   | 2.3: stopped |
| 0x2301   | 2.3: started |

    + Доступность: Все режимы

    Пример:

      + Запрос: ":abcd01006fb0\n"

      + Ответ: ":00abcd000110000b73\n"
             ":00abcd00011001cbb2\n"

3. Прочитать коэффициенты ПИД-регулятора: Kp, Ki, Kd

    * Запрос:

    `<funcid> = 0x02`

    `<argc> = 0`

    * Ответ:

    `<resc> = 6`

    `<resv[0]>` - `<Kp>`, пропорциональный коэффициент, целая часть числа в формате signed-fixed-point-16.16.

    `<resv[1]>` - `<Kp>`, пропорциональный коэффициент, дробная часть числа в формате signed-fixed-point-16.16.

    `<resv[2]>` - `<Ki>`, интегральный коэффициент, целая часть числа в формате signed-fixed-point-16.16.

    `<resv[3]>` - `<Ki>`, интегральный коэффициент, дробная часть числа в формате signed-fixed-point-16.16.

    `<resv[4]>` - `<Kd>`, дифференциальный коэффициент, целая часть числа в формате signed-fixed-point-16.16

    `<resv[5]>` - `<Kd>`, дифференциальный коэффициент, дробная часть числа в формате signed-fixed-point-16.16.

    + Доступность: Все режимы

4. Задать коэффициенты ПИД-регулятора: Kp, Ki, Kd

    * Запрос:

    `<funcid> = 0x03`

    `<argc> = 6`

    `<argv[0]>` - `<Kp>`, пропорциональный коэффициент, целая часть числа в формате signed-fixed-point-16.16.

    `<argv[1]>` - `<Kp>`, пропорциональный коэффициент, дробная часть числа в формате signed-fixed-point-16.16.

    `<argv[2]>` - `<Ki>`, интегральный коэффициент, целая часть числа в формате signed-fixed-point-16.16.

    `<argv[3]>` - `<Ki>`, интегральный коэффициент, дробная часть числа в формате signed-fixed-point-16.16.

    `<argv[4]>` - `<Kd>`, дифференциальный коэффициент, целая часть числа в формате signed-fixed-point-16.16

    `<argv[5]>` - `<Kd>`, дифференциальный коэффициент, дробная часть числа в формате signed-fixed-point-16.16.

    * Ответ:

    `<resc> = 0`

    + Доступность: Режим 2.3

5. Прочитать уставку скорости вращения стола

    * Запрос:

    `<funcid> = 0x04`

    `<argc> = 0`

    * Ответ:

    `<resc> = 1`

    `<resv[0]>` - Скорость вращения, число в диапазоне  `[0; 51 * <imp>]` импульсов/мин

    + Доступность: Все режимы

6. Задать уставку скорости вращения стола

    * Запрос:

    `<funcid> = 0x05`

    `<argc> = 1`

    `<argv[0]>` - Скорость вращения, число в диапазоне  `[ 0; 51 * <imp> ]` импульсов/мин

    * Ответ:

    `<resc> = 0`

    + Доступность: Режим 2.3

7. Прочитать действительную скорость вращения стола

    * Запрос:

    `<funcid> = 0x06`

    `<argc> = 0`

    * Ответ:

    `<resc> = 1`

    `<resv[0]>` - Скорость вращения, число в диапазоне  `[ 0; 51 * <imp> ]` импульсов/мин

    + Доступность: Все режимы

8. Запустить непрерывную передачу SP/PV

    * Запрос:

    `<funcid> = 0x07`

    `<argc> = 0`

    * Ответ:

    `<resc> = 0`

    + Доступность: Все режимы

9. Остановить непрерывную передачу SP/PV

    * Запрос:

    `<funcid> = 0x08`

    `<argc> = 0`

    * Ответ:

    `<resc> = 0`

    + Доступность: Все режимы

10. Сохранить конфигурацию

    * Запрос:

    `<funcid> = 0x09`

    `<argc> = 0`

    * Ответ:

    `<resc> = 0`

    + Доступность: Режим 2.3

### События

1. Событие переключения режима

     Событие инициируется при переключении режима работы.

    `<eventid>` = 0x00

    `<resc> = 1`

    `<resv[0]>` - Режим, смотри `<funcid> = 0x00`.

2. Событие SP/PV

     Событие всегда происходит через равные промежутки времени.

    `<eventid>` = 0x01

    `<resc> = 4`

    `<resv[0]>` - Время от запуска микроконтроллера, старшая честь, мс.

    `<resv[1]>` - Время от запуска микроконтроллера, младшая честь, мс.

    `<resv[2]>` - Setpoint (Уставка), cкорость вращения, число в диапазоне  `[0; 51 * <imp>]` импульсов/мин.

    `<resv[3]>` - Process Variable (Переменная процесса), cкорость вращения, число в диапазоне `[0; 51 * <imp>]` импульсов/мин.

## Коды ошибок

| Код(hex) | Описание |
| -------- | -------- |
| 0x00     | Нет ошибок |
| 0x01     | Команда недоступна в этом режиме |
| 0x02     | Неправильное количество аргументов |
| 0x03     | Значение агрумента вне диапазона |
