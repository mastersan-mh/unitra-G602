# Описание режимов работы

## 1. Стоп

  + Описание

    Стол остановлен, лифт поднят.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Включение базовой скорости 45 об/мин | Нет       |
| `[33]`           | Включение базовой скорости 33 об/мин | Нет       |
| `[АВТОСТОП]`     | Нет                                  | Нет       |
| `[ПУСК]`         | Переход в режим [2]                  | <1>       |
| `[СТОП]`         | Нет                                  | Нет       |
| `[СТОП]` в течении 5 секунд | Переход в режим [4.1]     | <6>       |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

## 2. Воспроизведение с фиксированной скоростью

  + Описание

    Воспроизведение с фиксированной скоростью, выбранной переключателями [45]/[33]. Стол вращается, лифт опущен.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1]                     | Нет       |
| `[33]`           | Смотри режим [1]                     | Нет       |
| `[АВТОСТОП]`     | Включение режима автоматической остановки стола и поднятия лифта при достижении конца записи | Нет |
| `[ПУСК]`         | Переход в режим [3]                  | <5>       |
| `[СТОП]`         | Переход в режим [1]                  | <2>       |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

## 3. Воспроизведение с регулируемой скоростью

  + Описание

    Воспроизведение со скоростью, выбранной переключателями [45]/[33] с возможность ручной подстройки регулятором [РЕГУЛЯТОР]:
    для базовой скорости 45 - в диапазоне от 39 до 51, для базовой скорости 33 - в диапазоне от 27 до 39 об/мин.
    Стол вращается, лифт опущен.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1]                     | Нет       |
| `[33]`           | Смотри режим [1]                     | Нет       |
| `[АВТОСТОП]`     | Смотри режим [2]                     | Нет       |
| `[ПУСК]`         | Переход в режим [2]                  | <5>       |
| `[СТОП]`         | Переход в режим [1]                  | <2>       |
| `[РЕГУЛЯТОР]`    | Ручная подстройка скорости воспроизведения | Нет |

### 4.1. Сервисный режим #1

  + Описание

    Режим настройки иглы: Стол остановлен, лифт опущен.

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1]                     | Нет       |
| `[33]`           | Смотри режим [1]                     | Нет       |
| `[АВТОСТОП]`     | Смотри режим [2]                     | Нет       |
| `[ПУСК]`         | Запуск режима                        | Нет       |
| `[СТОП]`         | Остановка режима / Переход в режим [4.2] | <2> / <4> |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

### 4.2. Сервисный режим #2

  + Описание

    Режим настройки скатывания иглы: Стол вращается, лифт опущен

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1]                     | Нет       |
| `[33]`           | Смотри режим [1]                     | Нет       |
| `[АВТОСТОП]`     | Смотри режим [2]                     | Нет       |
| `[ПУСК]`         | Запуск режима                        | Нет       |
| `[СТОП]`         | Остановка режима / Переход в режим [4.3] | <2> / <5> |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

### 4.3. Сервисный режим #3

  + Описание

    Настройки регулятора скорости внешними командами, принятыми из последовательного порта

  + Назначение органов управления

| Орган управления | Действие                             | Индикация |
| ---------------- | ------------------------------------ | --------- |
| `[45]`           | Смотри режим [1]                     | Нет       |
| `[33]`           | Смотри режим [1]                     | Нет       |
| `[АВТОСТОП]`     | Смотри режим [2]                     | Нет       |
| `[ПУСК]`         | Запуск режима                        | Нет       |
| `[СТОП]`         | Остановка режима / Переход в режим [1] | <2> / <6> |
| `[РЕГУЛЯТОР]`    | Нет                                  | Нет       |

# Индикация

| № | Тип мигания                     | Тип мигания                     | Значение                                    |
| - | ------------------------------- | ------------------------------- | ------------------------------------------- |
| 1 | `*-**--***---****----*****`     | Ускоряющееся мигание            | Запуск воспроизведения                      |
| 2 | `*****-----****----***---**--*` | Замедляющееся мигание           | Остановка воспроизведения                   |
| 3 | `**`                            | 1 мигание                       | Включено автоматическое упавление скоростью / Переход в сервисный режим #1 |
| 4 | `**--**`                        | 2 мигание                       | Переход в сервисный режим #2 |
| 5 | `**--**--**`                    | 3 мигания                       | Включено ручное упавление скоростью / Переход в сервисный режим #3 |
| 6 | `*-*-*-*-*-*`                   | Частое мигание 6 раз            | Переход в меню переключения сервисных режимов / Выход из меню сервисных режимов |
| 7 | `***---...`                     | медленное непрерывное мигание   | Торможение стола выбегом                    |
| 8 | `*-...`                         | частое непрерывное мигание      | Разгон стола                                |

# Протокол коммуникации посредством последовательного порта

## Назначение

Коммуникация посредством последовательного порта нужна для отладки изделия и для настройки коэффициентов регулятора скорости стола.

## Формат команды

Команды представляют собой набор ASCII-символов в 8-битной кодировке. Все числа представляются в 16-ричном формате,
цифры представлены множеством символов 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, A, B, C, D, E, F.

Формат кадра запроса:

    `<start><id><payload><CRC><TERM>`

Формат кадра ответа:

    `<start><id>00<payload><CRC><TERM>`
    `<start><id><error><CRC><TERM>`

`<start>`   - символ ':';
`<id>`      - Произвольное 16-битное число, испрользуется для идентификации запроса и ответа. Ответ содержит то-же число, что и запрос.
`<error>`   - Ошибка, 8-битное число.
`<payload>` - Данные пакета. Если <error> != 0, поле отсутствует.
`<CRC>`     - Контрольная сумма без стартового символа;
`<TERM>`    - Любой из символов CR (0x0D, '\r'), LF (0x0A, '\n')  и их сочетания, 1-2 байта. В кадре ответа всегда LF.

* Прочитать значение количества имульсов на один оборот стола.

    Запрос:

    `<payload> = RI`

    Ответ:

    `<payload> = RI<imp>`

    `<imp>` - Количество импульсов на один оборот стола.

    Доступность: Все режимы

* Прочитать номер режима.

    Запрос:

    `<payload> = RM`

    Ответ:

    `<payload> = RM<mode>`

    `<mode>` - номер режима.
    
| Значение | Номер режима |
| -------- | ------------ |
| 0x10     | 1            |
| 0x20     | 2            |
| 0x30     | 3            |
| 0x41     | 4.1          |
| 0x42     | 4.2          |
| 0x43     | 4.3          |

    Доступность: Все режимы

* Прочитать коэффициенты ПИД-регулятора: Kp, Ki, Kd

    Запрос:

    `<payload> = RK`

    Ответ:

    `<payload> = RK<Kp><Ki><Kd>`

    `<Kp>` - Пропорциональный коэффициент, 32-битное число в формате signed-fixed-point-16.16
    `<Ki>` - Интегральный коэффициент, 32-битное число в формате signed-fixed-point-16.16
    `<Kd>` - Дифференциальный коэффициент, 32-битное число в формате signed-fixed-point-16.16

    Доступность: Все режимы

* Задать коэффициенты ПИД-регулятора: Kp, Ki, Kd

    Запрос:

    `<payload> = WK`

    Ответ:

    `<payload> = WK`

    `<Kp>` - Пропорциональный коэффициент, 32-битное число в формате signed-fixed-point-16.16
    `<Ki>` - Интегральный коэффициент, 32-битное число в формате signed-fixed-point-16.16
    `<Kd>` - Дифференциальный коэффициент, 32-битное число в формате signed-fixed-point-16.16

    Доступность: Режим 4.3

* Прочитать текущую скорость вращения стола

    Запрос:

    `<payload> = RS`

    Ответ:

    `<payload> = RS<S>`

    `<S>` - Скорость вращения, 16-битное число в диапазоне  [0; 51 * <imp>] импульсов/оборот

    Доступность: Все режимы

* Задать скорость вращения стола

    Запрос:

    `<payload> = WS<S>`

    `<S>` - Скорость вращения, 16-битное число в диапазоне  [0; 51 * <imp>] импульсов/оборот

    Ответ:

    `<payload> = WS`

    Доступность: Режим 4.3

* Запустить непрерывную передачу SP/PV

    Запрос:

    `<payload> = AP`

    Ответ:

    `<payload> = AP`

    Доступность: Все режимы

* Остановить непрерывную передачу SP/PV

    Запрос:

    `<payload> = ZP`

    Ответ:

    `<payload> = ZP`

    Доступность: Все режимы

* Пакет, содержащий SP/PV ()

     Пакет всегда отправляется через равные промежутки времени.

    `<payload> = AP<time><sp><pv>`

    `<time>` - Числоб 32 бита. Время от запуска микроконтроллера, мс;

    `<sp>`   - Setpoint (Уставка), cкорость вращения, 16-битное число в диапазоне  [0; 51 * <imp>] импульсов/оборот;

    `<pv>`   - Process Variable (Переменная процесса), cкорость вращения, 16-битное число в диапазоне  [0; 51 * <imp>] импульсов/оборот.

    Доступность: Все режимы

## Коды ошибок

| Код(hex) | Описание |
| -------- | -------- |
| 0x00     | Нет ошибок |
| 0x01     | Ошибка формата команды |
| 0x02     | Команда недоступна в этом режиме |
| 0x03     | Ошибка диапазона парамета |
